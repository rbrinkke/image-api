# Image Processor Service - Environment Configuration
# Copy this file to .env and configure for your environment

# =============================================================================
# OAUTH 2.0 RESOURCE SERVER CONFIGURATION
# =============================================================================
# The image-api acts as an OAuth 2.0 Resource Server
# Tokens are validated locally using the auth-api's public JWKS endpoint

# Auth-API Configuration
AUTH_API_ISSUER_URL=http://auth-api:8000
AUTH_API_JWKS_URL=http://auth-api:8000/.well-known/jwks.json

# Expected audience for this service (must match token's "aud" claim)
AUTH_API_AUDIENCE=image-api

# JWT Algorithm (RS256 for asymmetric key validation)
JWT_ALGORITHM=RS256

# JWKS cache TTL (how often to refresh public keys from auth-api)
JWKS_CACHE_TTL=3600  # 1 hour

# =============================================================================
# BACKWARD COMPATIBILITY (DEPRECATED)
# =============================================================================
# Old symmetric key (deprecated - only for testing with old tokens)
JWT_SECRET_KEY=change-this-in-production  # DEPRECATED: Use OAuth 2.0 tokens

# =============================================================================
# DISTRIBUTED AUTHORIZATION SYSTEM
# =============================================================================
# Auth-API Integration for group membership and permission checks
AUTH_API_URL=http://auth-api:8000
AUTH_API_TIMEOUT=5
AUTH_API_CHECK_ENDPOINT=/api/v1/authorization/check

# Authorization Cache (Redis-based)
AUTH_CACHE_ENABLED=true
AUTH_CACHE_TTL_ALLOWED=60   # Cache allowed permissions for 60s
AUTH_CACHE_TTL_DENIED=120   # Cache denied permissions for 120s

# Circuit Breaker (fail-closed protection)
CIRCUIT_BREAKER_ENABLED=true
CIRCUIT_BREAKER_THRESHOLD=5  # Open after 5 consecutive failures
CIRCUIT_BREAKER_TIMEOUT=60   # Stay open for 60s
AUTH_FAIL_OPEN=false         # false = fail-closed (deny when auth-api down)

# Bucket Validation
BUCKET_VALIDATION_STRICT=true  # Enforce org-{org_id}/groups/{group_id} format

# =============================================================================
# STORAGE BACKEND
# =============================================================================
# Options: "local" (filesystem) or "s3" (AWS S3 or S3-compatible)
STORAGE_BACKEND=local

# Local Storage Configuration
STORAGE_PATH=/data/storage

# S3 Storage Configuration (for production or MinIO)
# The image-api uses a SINGLE physical S3 bucket and treats logical bucket
# names (e.g., "org-123/groups/abc") as prefixes within that bucket.
# This is the industry-standard approach for multi-tenant S3 storage.

# STORAGE_BACKEND=s3
# AWS_REGION=eu-west-1                    # AWS region (e.g., eu-west-1, us-east-1)
# AWS_S3_BUCKET_NAME=image-api-prod       # Physical S3 bucket name
# AWS_ACCESS_KEY_ID=your-access-key       # AWS credentials (or use IAM roles)
# AWS_SECRET_ACCESS_KEY=your-secret-key

# For MinIO or S3-compatible services (development/testing)
# AWS_ENDPOINT_URL=http://minio:9000      # Custom S3 endpoint (leave empty for AWS S3)

# =============================================================================
# DATABASE
# =============================================================================
DATABASE_PATH=/data/processor.db

# =============================================================================
# REDIS
# =============================================================================
REDIS_URL=redis://redis:6379/0

# =============================================================================
# RATE LIMITING
# =============================================================================
RATE_LIMIT_MAX_UPLOADS=50
RATE_LIMIT_WINDOW_MINUTES=60

# =============================================================================
# UPLOAD CONSTRAINTS
# =============================================================================
MAX_UPLOAD_SIZE_MB=10
ALLOWED_MIME_TYPES=["image/jpeg","image/png","image/webp"]

# =============================================================================
# IMAGE PROCESSING
# =============================================================================
WEBP_QUALITY=85

# Image sizes (max dimensions in pixels)
# IMAGE_SIZES={"thumbnail":150,"medium":600,"large":1200,"original":4096}

# =============================================================================
# SERVICE CONFIGURATION
# =============================================================================
SERVICE_NAME=image-processor
VERSION=1.0.0
ENVIRONMENT=development

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
# Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# JSON logging: true for production (structured logs), false for development (pretty console)
LOG_JSON=true

# Debug mode: enables additional debug features and pretty console output
DEBUG=false

# Development mode examples:
# DEBUG=true LOG_JSON=false  # Pretty console output with colors
# DEBUG=false LOG_JSON=true  # JSON structured logs (production-ready)

# Production mode:
# ENVIRONMENT=production LOG_LEVEL=INFO LOG_JSON=true DEBUG=false
